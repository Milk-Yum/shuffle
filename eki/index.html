<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eki Bottle Mail</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; background: linear-gradient(180deg, #a1c4fd 0%, #c2e9fb 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; color: #334d66; padding-bottom: 100px; }
        .container { width: 90%; max-width: 400px; margin-top: 40px; text-align: center; }
        h1 { font-size: 1.5rem; color: #ffffff; text-shadow: 1px 1px 4px rgba(0,0,0,0.1); }
        .station-box { background: rgba(255, 255, 255, 0.6); padding: 15px; border-radius: 20px; margin-bottom: 20px; font-weight: bold; backdrop-filter: blur(5px); min-height: 20px; }
        .bottle-card { background: #ffffff; padding: 25px; border-radius: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; margin-bottom: 40px; }
        textarea { width: 100%; height: 100px; border: 1px solid #e0e7ff; border-radius: 15px; padding: 12px; box-sizing: border-box; font-size: 16px; background: #f9fbff; -webkit-appearance: none; resize: none; }
        .btn-send { background: #5dade2; color: white; border: none; padding: 15px; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        
        /* è‡ªåˆ†ã®ãƒœãƒˆãƒ«ãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .my-bottles-section { width: 100%; text-align: left; }
        .my-bottles-title { font-size: 0.9rem; font-weight: bold; color: #667788; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .my-bottle-item { background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 15px; margin-bottom: 10px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .my-bottle-item:hover { background: rgba(255, 255, 255, 0.8); }
        .my-bottle-meta { font-size: 0.7rem; color: #8899aa; margin-top: 4px; }

        /* æ‹¾ã†ãƒœã‚¿ãƒ³ */
        .btn-pick-up { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; border: none; border-radius: 50%; width: 70px; height: 70px; font-size: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 10; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: white; padding: 20px; border-radius: 20px; width: 85%; text-align: center; max-width: 350px; max-height: 85vh; overflow-y: auto; }
        #picked-station { font-size: 0.8rem; color: #8899aa; margin-bottom: 10px; }
        #picked-text { font-size: 1.1rem; line-height: 1.5; margin-bottom: 20px; transition: opacity 0.5s; word-wrap: break-word; }
        
        .reply-section { border-top: 1px dashed #eee; padding-top: 15px; margin-top: 15px; text-align: left; }
        .reply-item { background: #f0f7ff; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; margin-bottom: 8px; color: #556677; }
        .reply-input-area { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .reply-input { font-size: 14px; height: 60px; border: 1px solid #eee; border-radius: 10px; padding: 8px; }
        .btn-reply-send { background: #a1c4fd; color: white; border: none; padding: 8px; border-radius: 10px; font-size: 0.8rem; cursor: pointer; }
        .btn-close { margin-top: 20px; background: #eee; border: none; padding: 10px 20px; border-radius: 20px; width: 100%; cursor: pointer; }

        /* çµµæ–‡å­—faviconè¨­å®š */
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¾</text></svg>">
    </style>
</head>
<body>

    <div class="container">
        <h1>Eki Bottle Mail</h1>
        <div id="station-display" class="station-box">æ½®ã®æµã‚Œã‚’ç¢ºèªä¸­...</div>
        
        <div class="bottle-card">
            <textarea id="message-input" placeholder="ä»Šã®æ°—æŒã¡ã‚’ãƒœãƒˆãƒ«ã«..."></textarea>
            <button id="send-btn" class="btn-send">æµ·ã¸æµã™</button>
        </div>

        <div class="my-bottles-section">
            <div class="my-bottles-title">ğŸ“¬ è‡ªåˆ†ã®æµã—ãŸãƒœãƒˆãƒ«</div>
            <div id="my-bottles-list"></div>
        </div>
    </div>

    <button id="pick-btn" class="btn-pick-up">ğŸ¾</button>

    <div id="overlay">
        <div class="modal">
            <div id="picked-station"></div>
            <p id="picked-text"></p>
            <div class="reply-section">
                <div id="reply-list"></div>
                <div class="reply-input-area" id="reply-form-area">
                    <textarea id="reply-input" class="reply-input" placeholder="è¿”ä¿¡ã‚’æ›¸ã..."></textarea>
                    <button id="reply-send-btn" class="btn-reply-send">è¿”ä¿¡ã‚’æ·»ãˆã‚‹</button>
                </div>
            </div>
            <button id="close-btn" class="btn-close">æµ·ã«æˆ»ã™</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, query, limit, serverTimestamp, updateDoc, increment, doc, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD4-mJxug55N26rxomekf1Tvn9YgToacTY",
            authDomain: "nakami-88027.firebaseapp.com",
            projectId: "nakami-88027",
            storageBucket: "nakami-88027.firebasestorage.app",
            messagingSenderId: "316064567852",
            appId: "1:316064567852:web:85642cd678d7b4160b7789"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentStation = "ã©ã“ã‹ã®ç·šè·¯ã®ä¸Š";
        let currentBottleId = null;

        // 1. ä½ç½®æƒ…å ±å–å¾—
        async function getStation() {
            const display = document.getElementById('station-display');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const url = `https://express.heartrails.com/api/json?method=getStations&x=${pos.coords.longitude}&y=${pos.coords.latitude}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data.response.station) {
                        const s = data.response.station[0];
                        currentStation = `${s.line} ${s.name}é§…`;
                        display.innerText = currentStation + " ä»˜è¿‘";
                    }
                } catch(e) { display.innerText = "é§…åå–å¾—ã«å¤±æ•—"; }
            });
        }

        // 2. ãƒœãƒˆãƒ«ã‚’æµã™
        document.getElementById('send-btn').onclick = async () => {
            const input = document.getElementById('message-input');
            if(!input.value) return alert("ä¸­èº«ã‚’æ›¸ã„ã¦ã­");
            try {
                const docRef = await addDoc(collection(db, "bottles"), {
                    text: input.value,
                    station: currentStation,
                    createdAt: serverTimestamp(),
                    readCount: 0 
                });
                
                // â˜… è‡ªåˆ†ã®ãƒœãƒˆãƒ«ã®IDã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                saveMyBottle(docRef.id, input.value);
                
                alert("ãƒœãƒˆãƒ«ã‚’æµã—ã¾ã—ãŸï¼");
                input.value = "";
                loadMyBottles(); // ãƒªã‚¹ãƒˆæ›´æ–°
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼ã§æµã›ã¾ã›ã‚“ã§ã—ãŸ"); }
        };

        // 3. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
        function saveMyBottle(id, text) {
            let list = JSON.parse(localStorage.getItem('myBottles') || '[]');
            list.unshift({ id, text: text.substring(0, 20) + "...", date: new Date().toLocaleDateString() });
            localStorage.setItem('myBottles', JSON.stringify(list.slice(0, 10))); // æœ€æ–°10ä»¶ä¿æŒ
        }

        function loadMyBottles() {
            const listDiv = document.getElementById('my-bottles-list');
            const list = JSON.parse(localStorage.getItem('myBottles') || '[]');
            listDiv.innerHTML = list.length ? "" : "<p style='color:#8899aa; font-size:0.8rem;'>ã¾ã æµã—ãŸãƒœãƒˆãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
            
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'my-bottle-item';
                div.innerHTML = `<div>${item.text}</div><div class="my-bottle-meta">${item.date} - çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹</div>`;
                div.onclick = () => showSpecificBottle(item.id);
                listDiv.appendChild(div);
            });
        }

        // 4. ç‰¹å®šã®ãƒœãƒˆãƒ«ã‚’è¡¨ç¤ºï¼ˆè‡ªåˆ†ç”¨ï¼‰
        async function showSpecificBottle(id) {
            const overlay = document.getElementById('overlay');
            const textDisplay = document.getElementById('picked-text');
            const stationDisplay = document.getElementById('picked-station');
            const replyList = document.getElementById('reply-list');
            document.getElementById('reply-form-area').style.display = 'none'; // è‡ªåˆ†ã®ãƒœãƒˆãƒ«ã«ã¯è‡ªåˆ†ã§è¿”ä¿¡ã—ãªã„è¨­å®š

            overlay.style.display = 'flex';
            textDisplay.innerText = "èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...";
            replyList.innerHTML = "";

            try {
                const d = await getDoc(doc(db, "bottles", id));
                if (d.exists()) {
                    const data = d.data();
                    currentBottleId = id;
                    textDisplay.innerText = data.text;
                    textDisplay.style.opacity = 1.0;
                    stationDisplay.innerText = `æ”¾æµåœ°: ${data.station} (ç¾åœ¨ã®é–²è¦§æ•°: ${data.readCount}å›)`;

                    // è¿”ä¿¡èª­ã¿è¾¼ã¿
                    const qReply = query(collection(db, "replies"), where("parentId", "==", id), orderBy("createdAt", "asc"));
                    const replySnap = await getDocs(qReply);
                    replySnap.forEach((rd) => {
                        const rDiv = document.createElement('div');
                        rDiv.className = 'reply-item';
                        rDiv.innerText = rd.data().text;
                        replyList.appendChild(rDiv);
                    });
                }
            } catch (e) { alert("ãƒœãƒˆãƒ«ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
        }

        // 5. ãƒœãƒˆãƒ«ã‚’æ‹¾ã†ï¼ˆé€šå¸¸ï¼‰
        document.getElementById('pick-btn').onclick = async () => {
            const textDisplay = document.getElementById('picked-text');
            const stationDisplay = document.getElementById('picked-station');
            const replyList = document.getElementById('reply-list');
            const overlay = document.getElementById('overlay');
            document.getElementById('reply-form-area').style.display = 'block';
            
            textDisplay.innerText = "æ‹¾ã„ä¸Šã’ã¦ã„ã¾ã™...";
            replyList.innerHTML = "";
            overlay.style.display = 'flex';

            try {
                const q = query(collection(db, "bottles"), where("readCount", "<", 11), limit(20));
                const snap = await getDocs(q);
                const bottles = [];
                snap.forEach((d) => bottles.push({ id: d.id, ...d.data() }));

                if(bottles.length > 0) {
                    const target = bottles[Math.floor(Math.random() * bottles.length)];
                    currentBottleId = target.id;
                    const newCount = (target.readCount || 0) + 1;
                    await updateDoc(doc(db, "bottles", target.id), { readCount: increment(1) });

                    const opacities = [1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.25, 0.1, 0.03];
                    textDisplay.innerText = target.text;
                    textDisplay.style.opacity = opacities[newCount - 1] || 0.03;
                    stationDisplay.innerText = `æ¼‚ç€åœ°: ${target.station || "ä¸æ˜"} (${newCount}å›ç›®)`;

                    const qReply = query(collection(db, "replies"), where("parentId", "==", target.id), orderBy("createdAt", "asc"));
                    const replySnap = await getDocs(qReply);
                    replySnap.forEach((rd) => {
                        const div = document.createElement('div');
                        div.className = 'reply-item';
                        div.innerText = rd.data().text;
                        replyList.appendChild(div);
                    });
                } else {
                    textDisplay.innerText = "æµ·ã«ã¯ã‚‚ã†ãƒœãƒˆãƒ«ãŒæ®‹ã£ã¦ã„ãªã„ã‚ˆã†ã§ã™...";
                }
            } catch (e) { console.error(e); }
        };

        // è¿”ä¿¡é€ä¿¡
        document.getElementById('reply-send-btn').onclick = async () => {
            const input = document.getElementById('reply-input');
            if(!input.value || !currentBottleId) return;
            try {
                await addDoc(collection(db, "replies"), {
                    parentId: currentBottleId,
                    text: input.value,
                    createdAt: serverTimestamp()
                });
                const div = document.createElement('div');
                div.className = 'reply-item';
                div.innerText = input.value;
                document.getElementById('reply-list').appendChild(div);
                input.value = "";
            } catch (e) { alert("è¿”ä¿¡å¤±æ•—"); }
        };

        document.getElementById('close-btn').onclick = () => {
            document.getElementById('overlay').style.display = 'none';
        };

        window.onload = () => { getStation(); loadMyBottles(); };
    </script>
</body>
</html>
